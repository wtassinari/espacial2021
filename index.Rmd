---
title: "Seminário do Programa de Pós-Graduação em Estatística Aplicada (PPGEAD): Introdução a Estatística Espacial"
author: "[**Wagner Tassinari (DEMAT/ICE/UFRRJ)**](https://github.com/wtassinari/espacial2021)"
date: "`r format(Sys.time(), '%d %B %Y')`"
logo: "figuras/logo_ufrrj.png"

output:
  prettydoc::html_pretty:
    theme: leonids
    highlight: github
---

```{r setup, include=FALSE}
library(knitr)
library(rmdformats)

## Global options
options(max.print="75")
knitr::opts_chunk$set(echo=FALSE,
               cache=TRUE,
               prompt=FALSE,
               tidy=TRUE,
               comment=NA,
               message=FALSE,
               warning=FALSE,
               cache.lazy=FALSE)
knitr::opts_knit$set(width=75)

```


```{r klippy}
# Insert copy to clipboard buttons in HTML documents
# remotes::install_github("rlesur/klippy")
klippy::klippy(
  lang = c("r", "markdown"),
  all_precode = FALSE,
  position = c("top", "right"),
  color = "blue",
  tooltip_message = "copiar código",
  tooltip_success = "copiado!"
)

```

# Introdução à Análise Estatística Espacial

## O que é Análise Estatística Espacial ?

- São métodos estatísticos que levam em consideração a localização espacial do fenômeno estudado;

- Defini-se *"Análise estatística espacial quando os dados são espacialmente localizados e se considera explicitamente a possível importância de seu arranjo espacial na análise ou interpretação dos resultados"* (Bailey & Gatrell, 1995).

- A primeira pergunta a ser feita é: A distribuição dos dados apresenta um padrão aleatório ou apresenta uma agregação definida (*clusters*) ?

```{r echo=F, fig.align="center", out.width= "80%", fig.show='hold'}
knitr::include_graphics('figuras/Cluster.png')
```

## Origem da Estatística Espacial

- Dr. John Snow (1813-1858) - Considerado pai da Epidemiologia Moderna


```{r echo=F, fig.align="center", out.width= "60%", fig.show='hold'}
knitr::include_graphics('figuras/snow2_2019.png')
# knitr::include_graphics('figuras/snow_2019.png')
```

Mapeamento dos casos de coléra ($\bullet$) e as bombas de água (X) em Londres, 1854.

## Objetivos da Estatística Espacial

1) Análise de padrões espaciais e espaço-temporais (ex: Análise
Exploratória Espacial, Correlação Espacial)

2) Modelagem Espacial (ex: Modelos Estatísticos de Regressão
Espacial)

## Dependência Espacial ou Autocorrelação Espacial

- "Independência é um pressuposto muito conveniente que faz
grande parte da teoria estatística matemática tratável.
Entretanto, modelos que envolvem dependência estatística são
frequentemente mais realísticos. . . . Neste tipos de dados a
dependência está presente em todas as direções e fica mais
fraca a medida em que aumenta a dispersão na localização dos
dados." (Cressie N.,1991)

- *"Todas as coisas se parecem, coisas mais próxmas são mais parecidas que
aquelas mais distantes."*  (Tobler, 1979). Também conhecida como $1^a$ Lei da Geografia

## Tipologia dos Dados Espaciais

Os diferentes tipos de dados espaciais são tradicionalmente classificados de acordo com uma tipologia. Esta caracterização diz respeito a natureza estocástica da observação.

Cressie divide a estatı́stica espacial em 3 grandes áreas:

  i) Dados de processos pontuais

  ii) Dados de geoestatística

  iii) Dados de área

Existem métodos estatı́sticos diferentes para descrever ou analisar estes tipos de dados.

```{r echo=F, fig.align="center", out.width= "60%", fig.show='hold'}
knitr::include_graphics('figuras/slide4.jpg')

```

## Padrões Pontuais

* O principal interesse está no conjunto de coordenadas geográficas representando as localizações exatas de eventos.

* Exemplos: Localização de crimes, localização da residência dos casos de dengue, localização de espécies vegetais, etc.

* Neste caso, o dado aleatório de interesse é a localização espacial do evento.


```{r echo=F, fig.align="center", message=FALSE, warning=FALSE, comments=NA, out.width="30%", comment=NA}
knitr::include_graphics('figuras/coordenadas.png')
```

```{r echo=F, fig.align="center", message=FALSE, warning=FALSE, comments=NA, out.width="70%", comment=NA}
knitr::include_graphics('figuras/pontos1.jpg')
```

```{r echo=F, fig.align="center", out.width= "60%", fig.show='hold'}
knitr::include_graphics('figuras/Cluster2.png')
```

### Estimativas de Kernel (ou Mapas de Calor)

```{r echo=F, fig.align="center", out.width= "60%", fig.show='hold'}
knitr::include_graphics('figuras/kernel.png')
```

### Localização da ocorrência de casos de dengue em Belo Horizonte/MG

```{r echo=F, fig.align="center", out.width= "60%", fig.show='hold'}
knitr::include_graphics('figuras/dengueBH.png')
```

## Geoestatística

* Podemos definir como sendo uma análise de um atributo espacialmente contínuo amostrado em localizações fixas.

* Os dados compreendem um conjunto de localizações (em geral latitudes e longitudes), mas agregados a eles uma medida, como por exemplo:

* Bastante utilizada em ciências ambientais (ex: volume de chuva, concentração de poluentes no ar, número de ovos de Aedes postado em ovitrampas, etc.)

### Exemplo: Mapa sobre o teor de argila no solo.

```{r echo=F, fig.align="center", out.width= "80%", fig.show='hold'}
knitr::include_graphics('figuras/geoestatistica7.png')
```

* Aqui os pesos são determinados a partir de uma análise espacial, baseada no **semivariograma** experimental. 

```{r echo=F, fig.align="center", out.width= "30%", fig.show='hold'}
knitr::include_graphics(c('figuras/variograma1.png', 'figuras/variograma2.png'))
```

* Além disso, a **Krigeagem** fornece, em média, estimativas não tendênciosas e com variância mínima.


## Dados de Área

* Na análise de áreas o atributo estudado é em geral resultado de uma contagem ou uma medida de síntese (em geral somas ou médias).

* O objetivo é a detecção e explicação de padrões e tendências observados entre áreas.

* Área é definida por um polígono cuja forma pode ser complexa bem como as relações de vizinhança.

### Mapa Temático

```{r echo=F, fig.align="center", out.width="80%", fig.cap="Taxas de câncer de pulmão na população branca masculina nos Estados Unidos, por condados no ano de 1998"}
knitr::include_graphics('figuras/area1_2019.png')
```

### Matriz de Vizinhança

```{r echo=F, fig.align="center", out.width="60%"}
knitr::include_graphics('figuras/vizinhanca.png')
```

### Lisa Map ou Moran Local

```{r echo=F, fig.align="center", out.width="60%", fig.cap="Mapa temáticos com o Moran Global da Incidência de Hansenı́ase São Paulo,1989"}
knitr::include_graphics('figuras/Moran_hansen0.png')
```

### Lisa Map ou Moran Local

```{r echo=F, fig.align="center", out.width="60%"}
knitr::include_graphics('figuras/moran.png')
```

### Modelos de Regressão Espacial

* Hipótese de independência das observações em geral é Falsa $\rightarrow$ Dependência Espacial

* Efeitos Espaciais $\rightarrow$ Se existir forte tendência ou correlação espacial, os resultados serão influenciados, apresentando associação estatística onde não existe (e vice-versa);

* Como verificar ? $\rightarrow$ Medir a autocorrelação espacial dos resíduos da regressão (Índice de Moran dos resíduos).

* Autocorrelação espacial constatada ! E agora ? $\rightarrow$ Utilizar Modelos de regressão que incorporam efeitos espaciais:

    i) **Globais:** utilizam um único parâmetro para capturar a estrutura de correlação espacial $\rightarrow$ ex: *Spatial Error Models (CAR)*: atribuem a autocorrelação ao erro;
    
    ii) **Locais:** parâmetros variam continuamente no espaço (ex: *Geographically weighted regression (GWR)*)
    
    
## Como trabalhar com Análise Estatística Espacial

```{r echo=F, fig.align="center", out.width="60%"}
knitr::include_graphics('figuras/logo_ubuntu.png')
```


Fonte: [Dicas para integração e instalação do R 4.0 no Ubuntu 20.04 LTS e os pacotes espaciais](https://rtask.thinkr.fr/installation-of-r-4-0-on-ubuntu-20-04-lts-and-tips-for-spatial-packages/)

https://ogcruz.github.io/Bookdown/dados-de-area-iii.html


## Exemplo com os dados de dengue em Dourados/MS

Nesta apresentação serão utilizados os dados que fizeram parte da dissertação de [Isis Rodrigues Reitman](https://sucupira.capes.gov.br/sucupira/public/consultas/coleta/trabalhoConclusao/viewTrabalhoConclusao.jsf?popup=true&id_trabalho=3666174) intitulada *“SAÚDE E AMBIENTE URBANO: A RELAÇÃO DE INCIDÊNCIA DE DENGUE E AS DISPARIDADES ESPACIAIS EM DOURADOS – MS"*, apresentada no [Programa de Pós-Graduação em Geografia da Universidade Federal da Grande Douradosos/MS](https://portal.ufgd.edu.br/pos-graduacao/mestrado-doutorado-geografia/index), em abril de 2016. 


Essa aplicação também se encontra no [Curso de Estudos Ecológicos](https://ogcruz.github.io/) ministrado para o curso de [Pós-Graduação em Epidemiologia em Saúde Pública](http://ensino.ensp.fiocruz.br/cursos/mestrado-e-doutorado/epidemiologia-em-saude-publica) em 2019, pelos pesquisadores [Oswaldo Gonçalves Cruz (PROCC/FIOCRUZ)](https://lsbastos.github.io/PROCC/membro-9530671289607786.html) e [Wagner Tassinari (DEMAT/ICE/UFRRJ)](https://institucional.ufrrj.br/ruralpesquisa/wagner-de-souza-tassinari/)


### Biliotecas do R que serão utilizadas

```{r, echo=T}

library(readr)
library(tidyverse)
library(sf)
library(maptools)
library(spatstat)
library(tmap)
```

### Lendo a tabela da população por setor censitário e os shapes files do contorno e por setor censitário de Dourados/MS

```{r, echo=T}
unzip('dados/pop2010.zip', exdir='dados')
pop2010 <- read_csv('dados/pop2010.csv')

unzip('malhas/Setor_UTM_SIRGAS.zip', exdir='malhas')
setor.sf <- read_sf('malhas/Setor_UTM_SIRGAS.shp', crs = 31981)

unzip('malhas/contorno.zip', exdir='malhas')
contorno.sf <- read_sf('malhas/contorno.shp', crs = 31981)

```

### Fazendo um join com as tabelas com os setores censitários + popoulação

```{r, echo=T}
setor.sf <- setor.sf %>% mutate (idsetor = as.numeric(CD_GEOCODI)) %>% inner_join(pop2010,by='idsetor')
```

### Lendo e plotando os casos de dengue georreferenciados em Dourados/MS

```{r, echo=T}
unzip('dados/dengue_dourados.zip', exdir='dados')
casos <- read_csv('dados/dengue_dourados.csv')
casos.sf <- st_as_sf(casos, coords = c("X", "Y"), crs = 31981)
```

```{r, echo=T, out.width="70%"}
ggplot(setor.sf) + 
  geom_sf(fill = 'white', color='black') +
  geom_sf(data=casos.sf, color='red',size=1) +
  theme_void()
```

### Lendo e plotando os os pontos de coleta de lixo georreferenciados em Dourados/MS

```{r, echo=T}
unzip('dados/lixo_dourados.zip', exdir='dados')
lixo <- read_csv2('dados/lixo_dourados.csv')
lixo.sf <- st_as_sf(lixo, coords = c("X", "Y"), crs = 31981)
```

```{r, echo=T,  out.width="70%"}
ggplot(setor.sf) + 
  geom_sf(fill = 'white', color = 'black') +
  geom_sf(data=lixo.sf,color='blue',size=1) +
  theme_void()
```

Como podemos observar, existem alguns pontos de coleta de lixo fora do contorno de Dourados/MS

### Uma forma de ficarmos só com os pontos dentro do polígono é utilizando o comando st_intersection.


```{r, echo=T}
lixo2.sf <- st_intersection(contorno.sf, lixo.sf)
```

```{r, echo=T,  out.width="70%"}
ggplot(setor.sf) + 
  geom_sf(fill = 'white', color = 'black') +
  geom_sf(data=lixo2.sf,color='blue',size=1) +
  theme_void()
```

### Utilizando as informações dos casos (pontos) + do lixo (ponto) + população de cada setor censitário (mapa temático)

```{r, echo=T,  out.width="70%"}
ggplot(setor.sf) + 
  geom_sf(aes(fill=pop)) + 
  geom_sf(data=casos.sf,color='red',size=0.7, aes(colour = "Caso"), 
          show.legend = "point") +
  geom_sf(data=lixo2.sf,color='salmon',size=1, aes(colour = "Lixo"), 
          show.legend = "point") +
  scale_fill_distiller(palette ="PuBu", direction = 1) +
  scale_colour_manual(values = c("Caso" = "red", "Lixo" = "slamon")) +
  theme_minimal()
```

### Agora serão construidos buffers de 500m de distância ao redor de cada ponto de coleta de lixo. Isso é interessante para verificar se os casos de dengue ocorrem em um raio de até 500m de distância dos pontos de coleta de lixo. Ou seja, a pergunta é, será que a distância dos pontos de coeta de lixo influenciam a ocorrência do caso de dengue ?

**Buffers:** São polígonos que contornam um objeto a uma determinada distância. Sua principal função é materializar os conceitos de “perto” e “longe”.

```{r, echo=T,  out.width="70%"}
lixo_buffer <- st_buffer(lixo2.sf, 500) 

ggplot(setor.sf) + 
  geom_sf(aes(fill=pop)) + 
  geom_sf(data=lixo_buffer,color='gray', fill = "transparent", size=0.4) +
  geom_sf(data=casos.sf, color='red',size=0.7) +
  scale_fill_distiller(palette ="PuBu", direction = 1) +
  scale_colour_manual(values = c("Caso" = "red", "Lixo" = "slamon")) +
  theme_minimal()
```

### Represntando os casos e o lixo de forma interativa

```{r, echo=T,  out.width="90%"}
tm_shape(setor.sf) +  tm_borders("black") +
  tm_shape(casos.sf) + tm_dots("red") +
  tm_shape(lixo.sf) + tm_dots("green") +
  tm_shape(lixo_buffer) + tm_borders("blue") +
  tmap_mode("view")
```

### Convertendo o dado de pontos (padrão pontual) para dados de área

```{r, echo=T}
## conta casos por setor 
casos.sf$contador <- 1 
casos <- setor.sf %>%  
  st_join(casos.sf) %>% 
  filter(CLASSI_FIN == 1) %>%  ## seleciona somente os casos confirmados
  group_by(ID) %>% 
  summarise(casos = sum(contador))

st_geometry(casos) <- NULL  ## remove atributos de geometria

## numero de depositos de Lixo por setor 
lixo.sf$contador <- 1 

lixo <- setor.sf %>%  
  st_join(lixo.sf) %>% 
  group_by(ID) %>% 
  summarise(lixo = sum(contador))

st_geometry(lixo) <- NULL ## remove atributos de geometria

# Inserindo as contagens dos casos e de pontos de coleta de lixo no atributo com a geometria.
setor.sf <- setor.sf %>% 
  left_join(lixo,by = 'ID') %>% 
  left_join(casos,by = 'ID') 
```


### Plotando o mapa temático dos casos por setor censitário

```{r, echo=T,  out.width="70%"}
plot(setor.sf['casos'])
```

### Plotando o mapa temático dos pontos de coleta de lixo por setor censitário

```{r, echo=T,  out.width="70%"}
plot(setor.sf['lixo'])
```

### Calculando a taxa de incidência e plotando o mapa temático dos pontos de coleta de lixo por setor censitário

```{r, echo=T,  out.width="70%"}
setor.sf$tx <- (setor.sf$casos/setor.sf$pop) * 1000
setor.sf$tx[is.na(setor.sf$tx)] <- 0 # Transformando os missings em zero

summary(setor.sf$tx)
```

### Plotando a distribuição da incidência em Dourados/MS

```{r, echo=T,  out.width="70%"}
library(wesanderson)
pal <- wes_palette("Moonrise3", 20, type = "continuous")

ggplot(setor.sf) + 
  geom_sf(aes(fill = tx), color = 'black') +
  scale_fill_gradientn(colours = pal) +
  ggtitle("Taxa de incidência de Dengue") + 
  theme_void()
```

### Kernel por atributos

Vamos plotar o kernel por atributos referente a taxa de incidência de dengue em Dourados/MS.

Primeiramente é necessário dissolver os polígonos em formato sf para obter o contorno. Nesse caso queremos preservar o atributo AREA

```{r, echo=T,  out.width="70%"}
dourados.contorno <- st_union(setor.sf)
plot(dourados.contorno)
```


```{r, echo=T,  out.width="70%"}
dourados.w <- as.owin(st_geometry(dourados.contorno))
```

### Extraindo os centróidas dos polígonos em Dourados/MS

```{r, echo=T,  out.width="70%"}
centroides <- st_centroid(st_geometry(setor.sf))

# Transformando em os centróides em formato sp
centroides.sp <- as.data.frame(as_Spatial(centroides))
names(centroides.sp) <- c('X','Y')

plot(centroides.sp)
```

### Colocando os pontos no formato sp

```{r, echo=T,  out.width="70%"}
centroides.ppp <- ppp(centroides.sp$X,centroides.sp$Y, dourados.w)

plot(centroides.ppp,pch=19,cex=0.5)
```

### Fazendo o kernel por atributo da taxa de detecção

```{r, echo=T,  out.width="70%"}
kernel.tx <- density(centroides.ppp, 500, weights = setor.sf$tx, scalekernel = TRUE)
plot(kernel.tx)
```

## Matriz de Vizinhança

### Construindo a matriz de vizinhança para verificar a autocorrelação espacial

```{r, echo=T,  out.width="70%"}
library(spdep)
viz <- poly2nb(setor.sf)
viz 
```


### Iremos precisar da coordenadas dos centróides

```{r, echo=T,  out.width="70%"}
setor.sp <- as(setor.sf, 'Spatial') # convertendo em formato sp
coord <- coordinates(setor.sp) # coordenadas dos centroidas dos poligonos de dourados
class(setor.sp)
```

### Verificando a malha de conectividade da vizinhança de Dourados/MS

```{r, echo=T,  out.width="70%"}
viz.sf <- as(nb2lines(viz, coords = coord), 'sf')
viz.sf <- st_set_crs(viz.sf, st_crs(setor.sf))

# Plota o grafo de conectividade por contiguidade
mapa.viz <- ggplot(setor.sf) + 
  geom_sf(fill = 'salmon', color = 'white') +
  geom_sf(data = viz.sf) +
  theme_minimal() +
  ggtitle("Vizinhança por \n conectividade") +
  ylab("Latitude") +
  xlab("Longitude")
mapa.viz
```

### Obtendo a correlação da taxa de incidência de dengue Dourados/MS

```{r, echo=T,  out.width="70%"}
pesos.viz <- nb2listw(viz)
moran.test(setor.sf$tx, pesos.viz)
```

### Plotando o correlograma

```{r, echo=T,  out.width="70%"}
correl <- sp.correlogram(viz, setor.sf$tx, order = 8, method = "I")
correl
```

```{r, echo=T,  out.width="70%"}
plot(correl)
```

### Mapeando os polígonos que tiveram os p-valores mais significativos no Moran Local.

```{r, echo=T,  out.width="70%"}
setor.sf$pval <- localmoran(setor.sf$tx, pesos.viz)[,5]

tm_shape(setor.sf) + 
  tm_polygons(col='pval', title="p-valores", breaks=c(0, 0.01, 0.05, 0.10, 1), border.col = "white", palette="-Oranges") +
  tm_scale_bar(width = 0.15) 
```

### Moran Local (Lisa Map) da taxa de incidência Dourados/MS

```{r, echo=T,  out.width="70%"}
resI <- localmoran.sad(lm(setor.sf$tx ~ 1), 1:length(viz), viz, style = "W")
summary(resI)[1:10,]
```


```{r, echo=T,  out.width="70%"}
setor.sf$MoranLocal <- summary(resI)[,1] 

library(scales)

ggplot(setor.sf) + 
  geom_sf(aes(fill = MoranLocal), color = 'black') +
  scale_fill_gradientn(colours=c("blue", "white", "red"), 
                       values=rescale(c(min(setor.sf$MoranLocal), 0, max(setor.sf$MoranLocal))), guide="colorbar") + 
  ggtitle("Moran local") + 
  theme_void()
```

##  Modelos Linear, CAR e GWR

### Ajustando o modelo de regressão linear simples.

```{r, echo=T,  out.width="70%"}
setor.sf$lixo[is.na(setor.sf$lixo)] <- 0 # Transformando os missings em zero

dourados.lm <- lm(tx ~ lixo, data=setor.sf)
summary(dourados.lm)
```

### Checando os residuos para verificar a presença de autocorrelação.

```{r, echo=T,  out.width="70%"}
dourados.lm$lmresid<-residuals(dourados.lm)
moran.test(dourados.lm$lmresid, pesos.viz)
```

### Ajustando o modelo CAR

```{r, echo=T,  out.width="70%"}
dourados.car<-errorsarlm(tx ~ lixo, data=setor.sf, listw=pesos.viz)
summary(dourados.car)
```

### Checando os residuos para verificar a presença de autocorrelação

```{r, echo=T,  out.width="70%"}
dourados.car$carresid<-residuals(dourados.car)
moran.test(dourados.car$carresid, pesos.viz)
```

### Ajustando o modelo GWR

```{r, echo=T,  out.width="70%"}
# Biblioteca para ajustar o  modelos GWR
library(spgwr)
# Estimando a largura de banda “ideal” para o kernel
GWRbanda <- gwr.sel(tx ~ lixo, data=setor.sf, coords=cbind(centroides.sp$X,centroides.sp$Y) , adapt=T) 
```

```{r, echo=T,  out.width="70%"}
dourados.gwr = gwr(tx ~ lixo, data=setor.sf, coords=cbind(centroides.sp$X,centroides.sp$Y), adapt=GWRbanda, hatmatrix=TRUE, se.fit=TRUE) 

dourados.gwr
```

```{r, echo=T,  out.width="70%"}
# Colocando a saída do modelo dentro de um dataframe.

results<-as.data.frame(dourados.gwr$SDF)
head(results)
```

### Verificando a distribuição dos coeficientes de regressão para a variável lixo


```{r, echo=T,  out.width="70%"}
hist(results$lixo)
abline(v = median(results$lixo), col="red")
```


### Verificando a distribuição dos localR2


```{r, echo=T,  out.width="70%"}
hist(results$localR2)
abline(v =median(results$localR2), col="blue")
```

### Incorporando alguns parâmetros de saída do modelo na tabela setor.sf

```{r, echo=T,  out.width="70%"}
setor.sf$coef.lixo<-results$lixo
setor.sf$localR2<-results$localR2
setor.sf$pred.gwr<-results$pred
```

### Mapa dos coeficientes de regressão para a variável lixo

```{r, echo=T,  out.width="70%"}
map.lixo <- ggplot(setor.sf) + 
  geom_sf(aes(fill = coef.lixo), color = 'black') +
  scale_fill_gradientn(colours = pal) +
  ggtitle("Distribuição dos coef. var. lixo") + 
  theme_void()
map.lixo
```

### Checando os residuos para verificar a presença de autocorrelação para o modelo GWR.

```{r, echo=T,  out.width="70%"}
# Calculando os resíduos para o modelo GWR
results$residuos <- setor.sf$tx - results$pred

moran.test(results$residuos, pesos.viz)
```

### Mapeando os coeficientes de regressão para a variável lixo por significancia através do teste de wald

```{r, echo=T,  out.width="70%"}
# Calculando a estatística de wald
setor.sf$wald.teste <- abs(results$lixo/results$lixo_se)
# Dicotomizando a estatística de wald
setor.sf$wald.teste <- ifelse(setor.sf$wald.teste < 2, 0, 1)


map.wald <- ggplot(setor.sf) + 
  geom_sf(aes(fill = factor(wald.teste)), color = 'black') +
  scale_fill_manual(values = c("white", "purple"), labels=c("< 2", ">= 2"), name='Wald') +
  ggtitle("Coef. lixo significativos") + 
  theme_void()


library(gridExtra)
grid.arrange(map.lixo, map.wald, ncol=2)
```

### Mapa dos coeficientes de determinação regionalizados ($R^2$ local).


```{r, echo=T,  out.width="70%"}
ggplot(setor.sf) + 
  geom_sf(aes(fill = localR2), color = 'black') +
  scale_fill_gradientn(colours = pal) +
  ggtitle("R² local") + 
  theme_void()
```

### Verificando a distribuição dos preditos.

```{r, echo=T,  out.width="70%"}
histdens <- function(x,titulo='') {
 densi  <- density(x)
 xli  <- range(densi$x)
 yli  <- range(densi$y)
 hist(x,col="red",probability = T,xlim = xli,ylim = yli,main=titulo)
 lines(densi,lwd=2)
 abline(v=median(x),lwd=4,col=4,lty=2)
}

attach(mtcars)
par(mfrow=c(2,2))

hist.tx <-  histdens(setor.sf$tx, "Tx Bruta")
hist.lm <-  histdens(dourados.lm$fitted.values, "Pred LM")
hist.car <-  histdens(dourados.car$fitted.values, "Pred CAR")
hist.gwr <-  histdens(results$pred, "Pred GWR")

```

### Mapeando os valores observados e preditos dos modelos ajustados


```{r, echo=T,  out.width="70%"}
library(colorspace) # 

setor.sf$brks <- cut(setor.sf$tx, include.lowest=TRUE,  right=TRUE,
                     breaks=c(-4, 0, 2, 4, 10, 57), 
                     labels=c("0", "0 - 2", "2 - 4", "4 - 10", "> 10"))

tx.bruta <- ggplot(setor.sf) + 
  geom_sf(aes(fill = brks), color = 'black') +
  ggtitle("Taxa Bruta") + 
  scale_fill_discrete_sequential(palette ='Heat2',  
                                 c1=80,c2 =30,l1=30,l2=90,p1=0.2,p2=1.5,
                                 na.value = "grey75", 
                                 drop=FALSE,
                                 name='Taxa') +
  theme_void()



setor.sf$brks.lm <- cut(dourados.lm$fitted.values, lowest=TRUE,  right=TRUE,
                        breaks=c(-4, 0, 2, 4, 10, 57), 
                        labels=c("0", "0 - 2", "2 - 4", "4 - 10", "> 10"))


pred.lm <- ggplot(setor.sf) + 
  geom_sf(aes(fill = brks.lm), color = 'black') +
  ggtitle("Taxa Predita - LM") + 
  scale_fill_discrete_sequential(palette ='Heat2',  
                                 c1=80,c2 =30,l1=30,l2=90,p1=0.2,p2=1.5,
                                 na.value = "grey75", 
                                 drop=FALSE,
                                 name='Taxa') +
  theme_void()

setor.sf$brks.car <- cut(dourados.car$fitted.values, lowest=TRUE,  right=TRUE,
                         breaks=c(-4, 0, 2, 4, 10, 57), 
                         labels=c("0", "0 - 2", "2 - 4", "4 - 10", "> 10"))


pred.car <- ggplot(setor.sf) + 
  geom_sf(aes(fill = brks.car), color = 'black') +
  ggtitle("Taxa Predita - CAR") + 
  scale_fill_discrete_sequential(palette ='Heat2',  
                                 c1=80,c2 =30,l1=30,l2=90,p1=0.2,p2=1.5,
                                 na.value = "grey75", 
                                 drop=FALSE,
                                 name='Taxa') +
  theme_void()

setor.sf$brks.gwr <- cut(results$pred, lowest=TRUE,  right=TRUE,
                         breaks=c(-4, 0, 2, 4, 10, 57), 
                         labels=c("0", "0 - 2", "2 - 4", "4 - 10", "> 10"))


pred.gwr <- ggplot(setor.sf) + 
  geom_sf(aes(fill = brks.car), color = 'black') +
  ggtitle("Taxa Predita - GWR") + 
  scale_fill_discrete_sequential(palette ='Heat2',  
                                 c1=80,c2 =30,l1=30,l2=90,p1=0.2,p2=1.5,
                                 na.value = "grey75", 
                                 drop=FALSE,
                                 name='Taxa') +
  theme_void()

library(gridExtra)
grid.arrange(tx.bruta, pred.lm, pred.car, pred.gwr, ncol=2)
```

### Verificando a distribuição dos resíduoas .


```{r, echo=T,  out.width="70%"}
library(vioplot)
vioplot(dourados.lm$residuals, dourados.car$residuals, results$residuos, names=c("LM", "CAR", "GWR"), col="orange")
title("Gráficos violinos da distribuição dos resíduos")
```

### Mapeando os resíduos dos modelos ajustados

```{r, echo=T,  out.width="70%"}
library(colorspace) # 

setor.sf$brks.res.lm <- cut(dourados.lm$residuals, include.lowest=TRUE,  right=TRUE,
                            breaks=c( -14, -5, -1, 1, 5, 52), 
                            labels=c("< -5", "-5 a -1", "0", "1 a 5", "> 5"))

res.lm <- ggplot(setor.sf) + 
  geom_sf(aes(fill = brks.res.lm), color = 'black') +
  ggtitle("Resíduos - LM") + 
  scale_fill_discrete_sequential(palette ='Purple-Yellow',  
                                 c1=80,c2 =30,l1=30,l2=90,p1=0.2,p2=1.5,
                                 na.value = "grey75", 
                                 drop=FALSE,
                                 name='Taxa') +
  theme_void()

setor.sf$brks.res.car <- cut(dourados.car$residuals, include.lowest=TRUE,  right=TRUE,
                             breaks=c( -14, -5, -1, 1, 5, 52), 
                             labels=c("< -5", "-5 a -1", "0", "1 a 5", "> 5"))

res.car <- ggplot(setor.sf) + 
  geom_sf(aes(fill = brks.res.car), color = 'black') +
  ggtitle("Resíduos - CAR") + 
  scale_fill_discrete_sequential(palette ='Purple-Yellow',  
                                 c1=80,c2 =30,l1=30,l2=90,p1=0.2,p2=1.5,
                                 na.value = "grey75", 
                                 drop=FALSE,
                                 name='Taxa') +
  theme_void()


setor.sf$brks.res.gwr <- cut(results$residuos, include.lowest=TRUE,  right=TRUE,
                             breaks=c( -14, -5, -1, 1, 5, 52), 
                             labels=c("< -5", "-5 a -1", "0", "1 a 5", "> 5"))

res.gwr <- ggplot(setor.sf) + 
  geom_sf(aes(fill = brks.res.gwr), color = 'black') +
  ggtitle("Resíduos - GWR") + 
  scale_fill_discrete_sequential(palette ='Purple-Yellow',  
                                 c1=80,c2 =30,l1=30,l2=90,p1=0.2,p2=1.5,
                                 na.value = "grey75", 
                                 drop=FALSE,
                                 name='Taxa') +
  theme_void()


library(gridExtra)
grid.arrange(res.lm, res.car, res.gwr, ncol=2)
```

## Bibliografia sugerida

* Druck, S.; Carvalho, M.S.; Câmara, G.; Monteiro, A.V.M. (eds) . [Análise Espacial de Dados Geográficos](http://www.dpi.inpe.br/gilberto/livro/analise/). Brasília, EMBRAPA, 2004.


* Interactive Spatial Data Analysis by Trevor C. Bailey , Anthony C. Gatrell Routledge, 1995

* Applied Spatial Statistics for Public Health Data; Lance A. Waller, Carol A. Gotway Wiley-Interscience 1St ed. 2004

* Applied Spatial Data Analysis with R; Roger S. Bivand, Edzer Pebesma , Virgilio Gomez-Rubio Springer; Edição: 2nd ed. 2013

* Geocomputation with R by Robin Lovelace, Jakub Nowosad and Jannes Muenchow. [Geocomputation with R](https://geocompr.robinlovelace.net/), 2021.